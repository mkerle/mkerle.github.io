---
layout: single
title:  "Linux SSH Command Logging"
date:   2022-09-06 17:00:00 +1000
toc: true
categories: linux ssh logging aureport
---

Key-logger type logging can be achieved with ssh using [aureport][aureport-man-page].

## aureport

aureport is a tool that produces summary reports of the audit system logs.

## SSH logging

Logging in sshd can be done by adding the following line in `/etc/pam.d/sshd`

{% highlight bash %}
session required pam_tty_audit.so enable=*
{% endhighlight %}

The `enable=*` tells sshd to start logging TTY input.

## Inspecting Audit Logs with aureport

To use `aureport` tool over the logs we can use the below command.  The `--tty` option will display all the keystrokes that were logged.

{% highlight bash %}
sudo aureport --tty
{% endhighlight %}

## Linux Audit Logs

Linux audit logs are generated by the Linux Audit Framework.  The logging of commands from sshd are encoded when written to `/var/log/audit/audit.log`.  These commands are encoded in hexadecimal.  NOTE that these logged command will include the hex "0D" character which corresponds to newline and depending on the decoding method should be stripped.

An example command to decode a command from the logs is below, where \<encoded command\> is the hex extracted from the `audit.log`.

{% highlight bash %}
echo "<encoded command>" | sed 's/0D//g' | xxd -r -p
{% endhighlight %}

In python this can be done like the below:

{% highlight python %}
regex_audit = "^type=TTY.*"+" uid=" + uid +".*data=.*"
for match in re.finditer(regex_audit, line, re.S):   
   encoded_commands = ((line.split("data=")[1])).strip()
   decoded_commands = (binascii.a2b_hex(encoded_commands))
   print(decoded_commands)
{% endhighlight %}

[aureport-man-page]: https://man7.org/linux/man-pages/man8/aureport.8.html